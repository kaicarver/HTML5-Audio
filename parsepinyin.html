<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Process Chinese tones</title>
  <style>
    textarea { width: 100%; height: 60px; }
    textarea#hanzi { height: 60px; }
  </style>
</head>
<body>
  <p>Experimental... Process tones in Chinese characters and pinyin. Eventually as a way to add tone marks to characters.</p>
  <p>For reference: Chinese text using Chinese characters:<br>
    <textarea id="hanzi" lang="zh-Hant">０、我知道騎腳踏車是一種很好的運動，週末假日，常常跟太太騎腳踏車到郊外去。
１、我的腳踏車是朋友送給我的，雖然看起來很舊，可是騎起來還不錯。
２、今天腳踏車有點怪怪的，不知道怎麼搞的，我一騎上去，車子就往旁邊歪。上車一看，原來後台沒氣了，只好把車推倒車行去，借個打氣筒打打氣。
３、老闆說我的車打氣沒用，因為車胎破了個小洞，爆胎了。怎麼又爆胎了？我上個禮拜才補過的。
４、我請老闆想辦法再幫我補一補，可是老闆說這部車的內胎已經補了兩次，不值得再補了，不如換個內胎比較划得來（划算）。
５、後來老闆發現腳踏板也壞了，鍊條也鬆了，所以建議我買部新車，他說現在的變速車騎起來又快又輕鬆。
６、我當然知道變速車好，可是這個月沒錢買。所以拜託老闆先幫我把舊車修理修理，等下個月再說吧！</textarea>
  </p>
  <p>Same Chinese text, in pinyin, currently entered by hand (e.g. provided by <a href="https://translate.google.com/#zh-CN/en/%E4%BC%8D%E9%BA%A5%E4%BA%9E%E7%8E%8B">Google Translate</a>):<br>
    <textarea id="pinyin">0, Wǒ zhīdào qí jiǎotàchē shì yīzhǒng hěn hǎo de yùndòng, zhōumò jiàrì, chángcháng gēn tàitài qí jiǎotàchē dào jiāowài qù. 
1, Wǒ de jiǎotàchē shì péngyǒu sòng gěi wǒ de, suīrán kànqǐlái hěn jiù, kěshì qíqǐlái hái bùcuò. 
2, Jīntiān jiǎotàchē yǒudiǎn guài guài de, bù zhīdào zěnme gǎo de, wǒ yī qí shàngqù, chēzi jiù wǎng pángbiān wāi. Shàng chē yī kàn, yuánlái hòutái méi qìle, zhǐhǎo bǎ chē tuīdǎo chē xíng qù, jiè gè dǎqìtǒng dǎdǎqì. 
3, Lǎobǎn shuō wǒ de chē dǎqì méi yòng, yīnwèi chētāi pòle gè xiǎo dòng, bàotāile. Zěnme yòu bàotāile? Wǒ shàng gè lǐbài cái bǔguò de. 
4, Wǒ qǐng lǎobǎn xiǎng bànfǎ zài bāng wǒ bǔ yī bǔ, kěshì lǎobǎn shuō zhè bù chē de nèitāi yǐjīng bǔle liǎng cì, bù zhídé zài bǔle, bùrú huàngè nèitāi bǐjiào huádélái (huásuàn). 
5, Hòulái lǎobǎn fāxiàn jiǎotàbǎn yě huàile, liàntiáo yě sōngle, suǒyǐ jiànyì wǒ mǎi bù xīn chē, tā shuō xiànzài de biànsùchē qíqǐlái yòu kuài yòu qīngsōng. 
6, Wǒ dāngrán zhīdào biànsùchē hǎo, kěshì zhège yuè méi qián mǎi. Suǒyǐ bàituō lǎobǎn xiān bāng wǒ bǎ jiù chē xiūlǐ xiūlǐ, děng xià gè yuè zàishuō ba!</textarea>
  </p>
  <button onclick="parsePinyin()">Parse pinyin</button>
  <button onclick="parseHanzi()">Parse Chinese characters</button>
  <button onclick="doclear()">Clear</button>
  <p>Parsed pinyin without tones:<br>
    <textarea id="notones"></textarea>
  </p>
  <p>Parsed pinyin in isolated syllables matching the characters:<br>
    <textarea id="parsedpinyin"></textarea>
  </p>
  <p>Parsed Chinese characters:<br>
    <textarea id="parsedhanzi"></textarea>
  </p>
  <script>
    function parsePinyin() {
      var pinyin = document.getElementById('pinyin').value;
      var notones = tr(pinyin,
			'āáǎàēéěèīíǐìōóǒòūúǔù',
			'aaaaeeeeiiiioooouuuu')
      document.getElementById('notones').value = notones;
      document.getElementById('parsedpinyin').value = splitpinyin(pinyin);
    }
    function parseHanzi() {
      var hanzi = document.getElementById('hanzi').value;
      document.getElementById('parsedhanzi').value = splithanzi(hanzi);
      //document.getElementById('parsedhanzi').value = '[not yet implemented]';
    }
    function doclear() {
      document.getElementById('notones').value = '';
      document.getElementById('parsedpinyin').value = '';
      document.getElementById('parsedhanzi').value = '';
    }
    function tr( text, search, replace ) {
      var regex = RegExp( '[' + search + ']', 'g' );
      var t = text.replace( regex, 
			    function( chr ) {
			      // Get the position of the found character in the search string.
			      var ind = search.indexOf( chr );
			      // Get the corresponding character from the replace string.
			      var r = replace.charAt( ind );
			      return r;
			    } );
      return t;
    }
    function splithanzi(hanzi) {
      // Chinese Character regex https://stackoverflow.com/questions/21109011/javascript-unicode-string-chinese-character-but-no-punctuation
      var regex = RegExp('[\u4E00-\u9FCC\u3400-\u4DB5\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\ud840-\ud868][\udc00-\udfff]|\ud869[\udc00-\uded6\udf00-\udfff]|[\ud86a-\ud86c][\udc00-\udfff]|\ud86d[\udc00-\udf34\udf40-\udfff]|\ud86e[\udc00-\udc1d]', 'g');
      var matches = [];
      var match;
      while (match = regex.exec(hanzi)) {
	//console.log(match);
	matches.push(match[0]);
	if (regex.lastIndex === match.index) {
	  regex.lastIndex++;
	}
      }
      return matches.length + ' ' + matches.join(' ');
    }
    function splitpinyin(pinyin) {
      // this regex parses pinyin without tones
      // based on https://stackoverflow.com/questions/20736291/regex-for-matching-pinyin
      // note that it cannot be perfect based on pinyin alone, for ex. huàngè = huàn gè or huàng è? This picks the more unlikely huàngè every time
      var re = '(([mM]iu|[pmPM]ou|[bpmBPM](o|e(i|ng?)?|a(ng?|i|o)?|i(e|ng?|a(o|n))?|u))|([fF](ou?|(a|e)(ng?|i)?|u))|([dD](e(i|ng?)|i(a(o|n)?|u))|[dtDT](a(i|ng?|o)?|e(i|ng)?|i(a(o|n)?|e|ng|u)?|o(ng?|u)|u(o|i|an?|n)?))|([nN]eng?|[lnLN](a(i|ng?|o)?|e(i|ng)?|i(ang|a(o|n)?|e|ng?|u)?|o(ng?|u)|u(o|i|an?|n)?|üe?))|([ghkGHK](a(i|ng?|o)?|e(i|ng?)?|o(u|ng)|u(a(i|ng?)?|i|n|o)?))|([zZ]h?ei|[czCZ]h?(e(ng?)?|o(ng?|u)?|ao|u?a(i|ng?)?|u?(o|i|n)?))|([sS]ong|[sS]hua(i|ng?)?|[sS]hei|[sS][h]?(a(i|ng?|o)?|en?g?|ou|u(a?n|o|i)?|i))|([rR]((a|e)ng?|i|e|ao|ou|ong|u(o|i|n)|ua?n?))|([jqxJQX](i(a(o|ng?)?|e|u|ong|ng?)?|u(e|a?n)?))|(((a|A)(i|o|ng?)?|(o|O)u?|(e|E)(i|ng?|r)?))|([wW](a(i|ng?)?|o|e(i|ng?)?|u))|[yY](a(o|ng?)?|e|in?g?|o(u|ng)?|u(e|a?n)?))';
      //console.log(re);
      // this makes the regex handle tones
      // note this hack allows forbidden combinations, but it may be good enough
      re = re.replace(/a/g,'[aāáǎà]');
      re = re.replace(/e/g,'[eēéěè]');
      re = re.replace(/i/g,'[iīíǐì]');
      re = re.replace(/o/g,'[oōóǒò]');
      re = re.replace(/u/g,'[uūúǔù]');
      //console.log(re);
      var regex = new RegExp(re, 'g');
      var matches = [];
      var match;
      while (match = regex.exec(pinyin)) {
	//console.log(match);
	matches.push(match[0]);
	// do we need this?
	if (regex.lastIndex === match.index) {
	  regex.lastIndex++;
	}
      }
      return matches.length + ' ' + matches.join(' ');
    }
    // even less used
    function splithanzi2(text) {
      // this regex parses out Chinese characters
      // based on https://stackoverflow.com/a/21113538/153144
      var re = '/[\u4E00-\u9FCC\u3400-\u4DB5\uFA0E\uFA0F\uFA11\uFA13\uFA14\uFA1F\uFA21\uFA23\uFA24\uFA27-\uFA29]|[\ud840-\ud868][\udc00-\udfff]|\ud869[\udc00-\uded6\udf00-\udfff]|[\ud86a-\ud86c][\udc00-\udfff]|\ud86d[\udc00-\udf34\udf40-\udfff]|\ud86e[\udc00-\udc1d]/';
      var regex = new RegExp(re, 'g');
      console.log(re);
      var matches = [];
      var match;
      while (match = regex.exec(text)) {
	//console.log(match);
	matches.push(match[0]);
	// do we need this?
	if (regex.lastIndex === match.index) {
	  regex.lastIndex++;
	}
      }
      return matches.length + ' ' + matches.join(' ');
    }
  </script>
</body>
</html>
